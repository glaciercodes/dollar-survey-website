<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dollarsurvey | Home</title>

  <style>
    :root{
      --bg:#000;
      --accent:#adff2f;
      --accent-darker:#8fd120;
      --muted:rgba(175,255,90,0.06);
      --card-shadow: 0 6px 24px rgba(173,255,47,0.06);
      --glass: rgba(0,255,0,0.03);
      --toast-bg: rgba(10,10,10,0.95);
      --max-width:1000px;
    }
    html,body{height:100%;}
    body{
      margin:0;
      font-family: "Segoe UI", system-ui, -apple-system, "Helvetica Neue", Arial;
      background:var(--bg);
      color:var(--accent);
      display:flex;
      justify-content:center;
      padding:28px 12px;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    header img {

    width: 70px;

    height: 70px;

    border-radius: 8px;

    border: 1px solid #0f0;

    }

    .wrap{
      width:100%;
      max-width:var(--max-width);
      display:flex;
      flex-direction:column;
      gap:20px;
    }

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:8px 4px;
    }

    .left{
      display:flex;
      align-items:center;
      gap:12px;
    }

    /* small horizontal info boxes beside logo */

    .info-boxes {
  display: flex;
  flex-direction: column; /* ‚¨ÖÔ∏è stacks them vertically */
  gap: 8px;               /* space between each box */
  align-items: stretch;   /* makes each box fill horizontally */
    }
    
    .info{
      display:flex;
      align-items:center;
      gap:8px;
      background:var(--glass);
      padding:6px 10px;
      border-radius:8px;
      border:1px solid rgba(173,255,47,0.08);
      font-size:13px;
      min-width:110px;
      justify-content:center;
      box-shadow:var(--card-shadow);
    }
    .info b{color:var(--accent); font-weight:700;}

    /* top-right modal menu button */
    .menu-btn{
      background:transparent;
      border:2px solid var(--accent);
      color:var(--bg);
      background-color:var(--accent);
      padding:8px 12px;
      border-radius:10px;
      cursor:pointer;
      font-weight:700;
      display:inline-flex;
      gap:10px;
      align-items:center;
    }

    /* modal */
    .modal{
      position:fixed;
      top:12px;
      right:12px;
      background:linear-gradient(180deg, rgba(0,0,0,0.95), rgba(0,0,0,0.85));
      border:2px solid var(--accent);
      border-radius:12px;
      padding:12px;
      min-width:220px;
      box-shadow:0 10px 40px rgba(0,0,0,0.6);
      display:none;
      z-index:60;
    }
    .modal a{display:block; color:var(--accent); text-decoration:none; padding:8px 4px;}
    .modal .close{font-size:12px; opacity:0.8; margin-top:6px; cursor:pointer;}

    /* main heading */
    main h1{
      margin:0;
      font-size:28px;
      line-height:1.05;
      font-weight:900;
      color:var(--accent);
      text-transform:none;
    }
    /* surveys grid */
    .surveys{
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:14px;
    }
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.08));
      border-radius:12px;
      padding:14px;
      border:1px solid rgba(173,255,47,0.06);
      box-shadow:var(--card-shadow);
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .card h3{
      margin:0;
      font-size:15px;
      font-weight:800;
      color:var(--accent);
    }
    .card p{
      margin:0;
      font-size:13px;
      color:rgba(173,255,47,0.9);
    }
    .answer{
      width:100%;
      min-height:56px;
      resize:vertical;
      border-radius:8px;
      padding:8px 10px;
      border:1px solid rgba(173,255,47,0.08);
      background:transparent;
      color:var(--accent);
      outline:none;
      font-size:14px;
    }
    .card-footer{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
    }
    .share-btn{
      background:transparent;
      border:none;
      color:var(--accent);
      cursor:pointer;
      font-size:20px;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }

    /* submit area */
    .submit-area{
      display:flex;
      justify-content:center;
      gap:12px;
      margin-top:6px;
    }
    .submit-btn{
      background:var(--accent);
      color:black;
      border:none;
      padding:12px 16px;
      border-radius:10px;
      font-weight:800;
      cursor:pointer;
      min-width:160px;
      box-shadow:0 8px 30px rgba(173,255,47,0.06);
    }
    .submit-btn[disabled]{opacity:0.5; cursor:not-allowed;}

    /* toast notifications */
    .toast{
      position:fixed;
      bottom:18px;
      left:50%;
      transform:translateX(-50%);
      background:var(--toast-bg);
      color:var(--accent);
      padding:12px 16px;
      border-radius:10px;
      border:1px solid rgba(173,255,47,0.08);
      box-shadow:0 8px 30px rgba(0,0,0,0.6);
      display:none;
      z-index:80;
      font-weight:700;
    }

    /* responsive */
    @media (max-width:880px){
      .surveys{grid-template-columns:1fr;}
      .info{min-width:90px; font-size:12px; padding:6px 8px;}
      .logo{width:48px;height:48px;}
      main h1{font-size:22px;}
    }
  </style>
</head>
<body>
  <div class="wrap" role="main">

    <header>
      <div class="left">
<img src="images/a6ee2559-b2a4-46be-a0ca-e71a28189c82.png" alt="Dollarsurvey Logo">
        <div class="info-boxes" aria-hidden="false">
          <div class="info" id="userIdBox"><span>ID:</span> <b id="userId">guest</b></div>
          <div class="info" id="balanceBox"><span>Balance:</span> <b id="balance">$0.00</b></div>
        </div>
      </div>

      <div>
        <button id="menuBtn" class="menu-btn" aria-expanded="false">Menu</button>
      </div>
    </header>

    <!-- modal menu -->
    <div id="menuModal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
      <a href="withdraw.html">Withdraw</a>
      <a href="faqs.html">FAQs</a>
      <a href="contact.html">Contact us</a>
      <a href="terms&privacy.html">Privacy Policy</a>
      <a href="index.html">Logout</a>
      <div class="close" id="closeModal">Close</div>
    </div>

    <main>
      <h1>We have got some surveys for youüìó</h1>

      <section class="surveys" id="surveysContainer">
        <!-- generated survey cards go here -->
      </section>

      <div class="submit-area">
        <button id="submitBtn" class="submit-btn">Submit All Answers</button>
      </div>
    </main>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <!-- Firebase + App logic -->
  <script type="module">
    // Firebase imports (same version pattern as your login/register)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-analytics.js";
    import {
      getAuth,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
    import {
      getDatabase,
      ref,
      set,
      push,
      child,
      get,
      update
    } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js";

    // your provided config
    const firebaseConfig = {
      apiKey: "AIzaSyDnq2364tMuRPbrjjHmUfFUTjWZC2BmIS4",
      authDomain: "dollar-survey-60fe7.firebaseapp.com",
      projectId: "dollar-survey-60fe7",
      storageBucket: "dollar-survey-60fe7.firebasestorage.app",
      messagingSenderId: "293471697208",
      appId: "1:293471697208:web:664863f09e830e420c69cd",
      measurementId: "G-RCZ7SQJHPZ"
    };

    const app = initializeApp(firebaseConfig);
    try { getAnalytics(app); } catch(e) { /* analytics may fail in some envs */ }

    const auth = getAuth(app);
    const db = getDatabase(app);

    // UI refs
    const surveysContainer = document.getElementById('surveysContainer');
    const submitBtn = document.getElementById('submitBtn');
    const toast = document.getElementById('toast');
    const userIdEl = document.getElementById('userId');
    const balanceEl = document.getElementById('balance');

    // menu
    const menuBtn = document.getElementById('menuBtn');
const menuModal = document.getElementById('menuModal');
const closeModal = document.getElementById('closeModal');

// Toggle menu when clicking the button
menuBtn.addEventListener('click', (event) => {
  event.stopPropagation(); // Prevent click from bubbling to document
  const open = menuModal.style.display === 'block';
  menuModal.style.display = open ? 'none' : 'block';
  menuBtn.setAttribute('aria-expanded', String(!open));
  menuModal.setAttribute('aria-hidden', String(open));
});

// Close button inside the menu
closeModal.addEventListener('click', () => {
  menuModal.style.display = 'none';
  menuBtn.setAttribute('aria-expanded', 'false');
  menuModal.setAttribute('aria-hidden', 'true');
});

// Close menu when clicking outside of it
document.addEventListener('click', (event) => {
  const isClickInside =
    menuModal.contains(event.target) || menuBtn.contains(event.target);

  if (!isClickInside && menuModal.style.display === 'block') {
    menuModal.style.display = 'none';
    menuBtn.setAttribute('aria-expanded', 'false');
    menuModal.setAttribute('aria-hidden', 'true');
  }
});

    // guest id (persistent)
    let currentUser = null;
    const guestIdKey = 'ds_guest_id_v1';
    function ensureGuestId(){
      let g = localStorage.getItem(guestIdKey);
      if(!g){
        g = 'g-' + Math.random().toString(36).slice(2,9);
        localStorage.setItem(guestIdKey, g);
      }
      return g;
    }
    const guestId = ensureGuestId();

    // UI helpers
    function showToast(message, ms=3000){
      toast.textContent = message;
      toast.style.display='block';
      setTimeout(()=> { toast.style.display='none'; }, ms);
    }

    function currency(amount){
      return '$' + amount.toFixed(2);
    }

    // initial UI values
    let localBalance = 0.00;
    function updateBalanceUI(){
      balanceEl.textContent = currency(localBalance);
    }
    updateBalanceUI();
    userIdEl.textContent = 'guest';

    // survey prompts (~50 words each). Kept concise but ~50 words each.
    const prompts = [
`When planning your weekly groceries, how do you decide between convenience foods and cooking from scratch? Consider freshness, preparation time, cost, taste preference, and health balance. Describe a situation where you‚Äôd choose quick frozen meals over fresh produce and what motivates that decision for your week.`,

`Think about your morning routine. Which matters most: waking up on time, breakfast, outfit selection, or quiet preparation space? Explain a day when adjusting your routine improved your energy or mood, and how those small changes influence the rest of your day‚Äôs productivity.`,

`When selecting a reusable water bottle, which features matter most? Consider capacity, insulation, weight, leak resistance, and cleaning ease. Describe an example where you‚Äôd pick a heavier insulated model for travel over a lightweight option for daily use, and what tradeoff feels worth it.`,

`Choosing a daily outfit often balances comfort, weather, and impression. Which factor leads your choice most days? Explain a scenario when you dressed more for comfort than appearance, or vice versa, and how that choice affected your confidence or comfort throughout the day.`,

`When deciding what to cook for dinner, what influences your choice most‚Äîingredients available, cooking time, taste, or nutrition? Describe a night when you chose a simple meal over an elaborate one and why that decision fit your schedule or energy level best.`,

`Think about planning weekend activities. Which factors guide you: relaxation, socializing, productivity, or outdoor fun? Describe a weekend when you consciously chose rest over social plans or vice versa, and how that affected your overall sense of balance.`,

`When buying everyday shoes, which aspects influence you most‚Äîcomfort, price, durability, or brand trust? Describe a time when you invested in a high-quality pair instead of a cheaper one and whether that decision felt worthwhile in the long run.`,

`Choosing a TV show to watch can depend on time, genre mood, or energy level. Which factor matters most for you? Describe a situation when you picked a relaxing show over a thought-provoking one and how that choice matched your mood or environment.`,

`When selecting a mobile data plan, what matters most‚Äîcoverage, speed, price, or data limit? Describe a scenario when you preferred a slightly more expensive plan for reliability and why that felt like a smart long-term choice for your daily usage.`,

`Think about your phone‚Äôs charging habits. Do you value fast charging, battery capacity, or durability more? Explain a moment when your charging setup (like a power bank or cable) made your routine easier and why that convenience mattered most.`,

`When buying a backpack or work bag, which qualities matter most‚Äîsize, material, comfort, or design? Describe a time when you chose practicality over style or vice versa, and how that decision impacted your daily comfort or confidence.`,

`Consider your morning commute. Do you prefer walking, public transport, or driving? Explain what influences your choice‚Äîcost, comfort, speed, or environmental impact‚Äîand describe a morning when that decision shaped how your day started.`,

`When cleaning your home, do you focus more on speed, thoroughness, scent, or product safety? Describe a cleaning session where you prioritized one factor over another and why that approach fit your mood, time, or goal that day.`,

`Choosing a lunch spot often balances cost, nutrition, taste, and proximity. Explain how you usually decide where to eat on busy workdays versus relaxed weekends, and describe an example when convenience outweighed variety for you.`,

`When buying toothpaste, which qualities influence your decision‚Äîflavor, whitening ability, brand, or sensitivity protection? Describe a case when you switched brands and how that change met or missed your expectations over time.`,

`Consider buying new bedsheets. What matters most‚Äîfabric quality, price, color, or thread count? Describe a purchase when comfort or durability influenced you more than style, and how that affected your satisfaction later on.`,

`When picking a phone case, which factor matters most‚Äîdesign, protection, grip, or price? Explain a moment when you sacrificed one aspect for another, such as style over durability, and how that tradeoff felt afterward.`,

`When choosing laundry detergent, do you prioritize scent, cleaning power, eco-friendliness, or price? Describe an instance when you tried a new brand and what made you keep or switch back afterward.`,

`When deciding how to spend a rainy day, do you prefer staying in, reading, cooking, or watching shows? Explain how your choice usually reflects your mood or need for rest, and describe a recent cozy day indoors.`,

`When picking light snacks, do you prefer salty, sweet, or balanced flavors? Explain how you decide between health-conscious and indulgent options, and share a situation when convenience influenced your snack choice most.`,

`When organizing your workspace, what‚Äôs most important‚Äîneatness, accessibility, aesthetics, or comfort? Describe how changing your setup once improved your focus or mood during work or study time.`,

`Choosing a daily planner or app depends on layout, reminders, simplicity, and syncing options. Which do you value most, and describe a time when better organization helped reduce stress or boost productivity.`,

`When purchasing soap or body wash, what matters most‚Äîfragrance, moisturizing ability, brand, or skin type compatibility? Share an instance when a product‚Äôs scent or packaging convinced you to try it over your usual choice.`,

`When listening to music during chores, what drives your selection‚Äîenergy level, lyrics, or background rhythm? Describe how certain songs or genres change your motivation or enjoyment while working.`,

`When buying groceries online, do you prioritize delivery speed, price, freshness, or variety? Describe a time when online shopping saved you time or caused a small issue that changed how you plan future orders.`,

`When selecting home lighting, what influences your decision‚Äîbrightness, energy use, style, or color tone? Explain how lighting choice once affected your mood or the atmosphere of a room.`,

`Choosing a reusable shopping bag depends on durability, capacity, design, and foldability. Which matters most for you, and describe a moment when having one made a big difference during a busy shopping trip.`,

`When picking a phone plan add-on, such as streaming data or hotspot, what influences you most‚Äîcost, usefulness, or entertainment options? Describe a case when you added or removed one and why.`,

`When choosing personal care items like shampoo, do you value scent, ingredients, packaging, or performance most? Describe a moment when trying a natural or premium option changed your perception of daily routines.`,

`When preparing for travel, do you focus more on comfort, efficiency, or style? Describe a packing experience where you learned to balance minimalism with preparedness and how it affected your trip.`,

`When replacing kitchen tools, what factors matter‚Äîprice, durability, brand, or ergonomics? Describe a moment when investing in a better-quality item saved time or frustration later.`,

`When downloading a new app, do you consider reviews, functionality, data privacy, or design first? Explain a time when one feature made you keep using the app despite small drawbacks.`,

`Choosing what to read‚Äîfiction, news, or blogs‚Äîoften reflects your mindset. Describe how your reading choice changes with time or mood and share a situation when one article or book brightened your day.`,

`When planning exercise routines, do you prioritize duration, enjoyment, convenience, or intensity? Explain a day when a short workout felt more rewarding than a long one and why that approach worked for you.`,

`When buying everyday clothes, what matters more‚Äîfit, color, versatility, or price? Describe a recent purchase that became your favorite because of its comfort or practicality.`,

`When managing your digital storage, do you delete old files regularly or rely on cloud backups? Explain your method and share how organization affects your productivity or peace of mind.`,

`When planning meals for the week, do you focus on nutrition, taste, or budget? Describe how one well-planned meal prep week improved your routine and reduced daily stress.`,

`When deciding on home fragrance‚Äîcandles, sprays, or diffusers‚Äîwhat matters most: scent longevity, design, or price? Describe a favorite scent and how it changes your home‚Äôs atmosphere.`,

`When using public transport, what factors matter‚Äîtimeliness, comfort, cleanliness, or safety? Describe a commute that stood out to you and why that experience shaped your preferences.`,

`When organizing digital photos, do you prefer cloud storage, albums, or local folders? Describe a system that helped you rediscover memories easily and why you‚Äôd recommend it.`,

`When choosing household paper products, what influences you‚Äîsoftness, strength, price, or eco-friendliness? Share an example when one quality made you stay loyal to a brand.`,

`When shopping for new glasses or sunglasses, do you prioritize frame design, comfort, price, or brand? Describe a purchase that made you feel confident and what drove your final decision.`,

`When updating your phone wallpaper, do you choose photos, quotes, or patterns? Explain how your choice reflects your personality or mood at the time.`,

`When cleaning digital devices, what matters‚Äîfrequency, tools used, or thoroughness? Describe how maintaining cleanliness once improved performance or satisfaction with your gadget.`,

`When choosing between handwritten notes and digital ones, which do you prefer and why? Describe a time when one method helped you stay more organized or creative.`,

`When planning movie nights, do you focus on genre, group choice, or time? Share how you balance everyone‚Äôs preferences or your own when deciding what to watch.`,

`When buying stationary, do you prefer design, smooth writing, durability, or brand? Describe how using good stationery improved your focus or enjoyment of daily writing tasks.`,

`When decorating your room, what‚Äôs most important‚Äîcomfort, color harmony, lighting, or minimalism? Explain how a small change once made your space feel better or more inspiring.`,

`When deciding on weekend chores, how do you balance them with relaxation? Describe a method that helps you stay productive without feeling overwhelmed or rushed.`,

`When using a streaming video platform, what features matter‚Äîrecommendations, ad-free experience, video quality, or cost? Describe a time when one feature made you switch or stay with a service.`
];

    // generate survey cards
    function renderSurveys(){
      surveysContainer.innerHTML = '';
      prompts.forEach((txt, idx) => {
        const card = document.createElement('article');
        card.className = 'card';
        const h3 = document.createElement('h3');
        h3.textContent = txt.slice(0, Math.min(80, txt.length)); // heading as bold extract
        const p = document.createElement('p');
        p.textContent = txt; // full ~50-word prompt

        const textarea = document.createElement('textarea');
        textarea.className = 'answer';
        textarea.placeholder = 'Write your answer (min 5 characters)...';
        textarea.minLength = 5;
        textarea.dataset.index = idx;

        const footer = document.createElement('div');
        footer.className = 'card-footer';

        const shareBtn = document.createElement('button');
        shareBtn.className = 'share-btn';
        shareBtn.title = 'Share homepage';
        shareBtn.innerHTML = '‚á™';
        shareBtn.addEventListener('click', ()=> shareHomepage());

        footer.appendChild(shareBtn);

        card.appendChild(h3);
        card.appendChild(p);
        card.appendChild(textarea);
        card.appendChild(footer);

        surveysContainer.appendChild(card);
      });
    }
    renderSurveys();

    // share helper
    function shareHomepage(){
      const url = window.location.origin + window.location.pathname;
      if(navigator.share){
        navigator.share({ title: 'Dollarsurvey', text: 'Check surveys on Dollarsurvey', url }).catch(()=>{ copyToClipboard(url); showToast('Link copied'); });
      } else {
        copyToClipboard(url);
        showToast('Link copied to clipboard', 1800);
      }
    }
    function copyToClipboard(text){
      try {
        navigator.clipboard.writeText(text);
      } catch(e){
        const ta = document.createElement('textarea');
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        ta.remove();
      }
    }

    // fetch balance from firebase (if user logged in)
    async function fetchBalanceFromFirebase(uid){
      try {
        const snap = await get(ref(db, 'users/' + uid + '/balance'));
        if(snap && snap.exists && typeof snap.val === 'function'){
          const val = snap.val();
          if(!isNaN(Number(val))) {
            localBalance = Number(val);
            updateBalanceUI();
          }
        }
      } catch(e){
        // ignore; keep localBalance as-is
      }
    }

    // update balance both locally and in firebase (attempt)
    async function increaseBalance(amount=0.5){
      localBalance = +(localBalance + amount).toFixed(2);
      updateBalanceUI();

      // optimistic: update UI first, then attempt firebase write
      if(currentUser && currentUser.uid){
        const uid = currentUser.uid;
        try {
          // get current DB balance, compute new (to avoid clobbering)
          const snap = await get(ref(db, 'users/' + uid + '/balance'));
          let dbBal = 0;
          if(snap && snap.exists && typeof snap.val === 'function') dbBal = Number(snap.val()) || 0;
          const newBal = +(dbBal + amount).toFixed(2);
          await set(ref(db, 'users/' + uid + '/balance'), newBal);
        } catch(err){
          // firebase failed, but UI already updated
          console.warn('balance write failed', err);
        }
      } else {
        // store guest balances under guests/<guestId>/balance
        try {
          const snap = await get(ref(db, 'guests/' + guestId + '/balance'));
          let dbBal = 0;
          if(snap && snap.exists && typeof snap.val === 'function') dbBal = Number(snap.val()) || 0;
          const newBal = +(dbBal + amount).toFixed(2);
          await set(ref(db, 'guests/' + guestId + '/balance'), newBal);
        } catch(err){
          console.warn('guest balance write failed', err);
        }
      }
    }

    // store answers to firebase: path submissions/users/<uid>/<ts> or submissions/guests/<guestId>/<ts>
    async function storeSubmissionToFirebase(payload){
      try {
        const base = currentUser && currentUser.uid ? `submissions/users/${currentUser.uid}` : `submissions/guests/${guestId}`;
        const ts = Date.now();
        await set(ref(db, `${base}/${ts}`), payload);
        return true;
      } catch(err){
        console.warn('submission write failed', err);
        return false;
      }
    }

    // gather answers and validate
    function gatherAnswers(){
      const textareas = Array.from(document.querySelectorAll('.answer'));
      const answers = textareas.map(t => t.value.trim());
      // ensure all filled with min 5 chars
      for(const a of answers){
        if(a.length < 5) return null;
      }
      return answers;
    }

    // submit flow
    submitBtn.addEventListener('click', async ()=>{
      const answers = gatherAnswers();
      if(!answers){
        showToast('Please answer every survey with at least 5 characters', 3000);
        return;
      }

      submitBtn.disabled = true;
      submitBtn.textContent = 'Submitting...';

      // Build payload
      const payload = {
        userId: currentUser && currentUser.email ? (currentUser.email.slice(0,5).toLowerCase()) : guestId,
        timestamp: Date.now(),
        answers,
        page: window.location.pathname
      };

      // Always succeed after 3 seconds (optimistic). Attempt firebase writes too.
      setTimeout(async ()=> {
        // optimistic UI success
        showToast('Submission successful! +$0.50 added', 3000);

        // clear answers
        document.querySelectorAll('.answer').forEach(a => a.value = '');

        // refresh surveys (re-render to simulate refresh)
        renderSurveys();

        // update balance locally and attempt firebase writes
        await increaseBalance(0.5);

        // attempt to store answers to firebase (best-effort)
        storeSubmissionToFirebase(payload).then(success => {
          if(!success){
            // attempted but failed; still show notification (already optimistic success)
            console.warn('Could not save submission to firebase');
          }
        });

        // final UI updates
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit All Answers';
      }, 3000);
    });

    // auth state tracking to set user id & fetch balance
    onAuthStateChanged(auth, (user) => {
      currentUser = user;
      if(user && user.email){
        const id = user.email.slice(0,5).toLowerCase();
        userIdEl.textContent = id;
        // try to get balance stored in firebase for this user
        fetchBalanceFromFirebase(user.uid).then(()=> {
          // if db had nothing, ensure UI uses stored or zero
          updateBalanceUI();
        });
      } else {
        // guest
        userIdEl.textContent = guestId.slice(0,5);
        // try to fetch guest balance
        (async ()=>{
          try {
            const snap = await get(ref(db, 'guests/' + guestId + '/balance'));
            if(snap && snap.exists && typeof snap.val === 'function'){
              localBalance = Number(snap.val()) || localBalance;
              updateBalanceUI();
            }
          } catch(e){}
        })();
      }
    });

    // ensure balance loads if previously stored in localStorage
    (function initLocalBalance(){
      const saved = localStorage.getItem('ds_local_balance_v1');
      if(saved && !isNaN(Number(saved))){
        localBalance = Number(saved);
        updateBalanceUI();
      }
      // persist balance update locally whenever it changes through the increaseBalance function
      // override increaseBalance to write to localStorage as well
      const origIncrease = increaseBalance;
      increaseBalance = async function(amount=0.5){
        // call original behavior
        await origIncrease(amount);
        localStorage.setItem('ds_local_balance_v1', String(localBalance));
      };
    })();

    // keep localBalance persisted on unload
    window.addEventListener('beforeunload', ()=> {
      localStorage.setItem('ds_local_balance_v1', String(localBalance));
    });

  </script>
</body>
</html>









