<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dollarsurvey | Home</title>
  <style>
    :root{
      --bg:#000;
      --accent:#adff2f;
      --accent-dim: rgba(173,255,47,0.12);
      --card-bg: rgba(10,10,10,0.6);
      --glass: rgba(255,255,255,0.02);
      --radius:12px;
      --max-width:980px;
      --gap:14px;
    }
    html,body{height:100%; margin:0; background:var(--bg); color:var(--accent); font-family: "Segoe UI", Roboto, system-ui, -apple-system, "Helvetica Neue", Arial;}
    .page{max-width:var(--max-width); margin:28px auto; padding:18px; box-sizing:border-box;}
    header{display:flex; align-items:center; gap:12px; padding:12px; border-radius:10px; background:linear-gradient(180deg, rgba(173,255,47,0.02), transparent); box-shadow:0 6px 30px rgba(173,255,47,0.02);}
    .logo { width:56px; height:56px; border-radius:10px; background:var(--glass); display:inline-flex; align-items:center; justify-content:center; border:1px solid rgba(173,255,47,0.08); }
    .logo a{ color:var(--accent); text-decoration:none; font-weight:700; display:inline-block; width:100%; height:100%; align-items:center; justify-content:center; display:flex; }
    .title { font-size:18px; font-weight:700; margin-left:6px; }
    .top-right { margin-left:auto; display:flex; gap:8px; align-items:center; }
    .user-card{ display:flex; gap:10px; align-items:center; background:var(--card-bg); padding:8px 12px; border-radius:10px; border:1px solid rgba(173,255,47,0.06); }
    .uid { font-weight:700; letter-spacing:1px; }
    .balance { font-weight:800; color:#000; background:var(--accent); padding:6px 10px; border-radius:8px; }
    .menu-btn { background:transparent; border:1px solid rgba(173,255,47,0.12); color:var(--accent); padding:8px 10px; border-radius:10px; cursor:pointer; }
    .hero{ margin-top:18px; display:flex; flex-direction:column; gap:8px; padding:16px; border-radius:12px; background:linear-gradient(180deg, rgba(173,255,47,0.02), transparent); }
    .surveys-heading { font-size:26px; font-weight:900; margin:8px 0; color:var(--accent); letter-spacing:0.6px; }
    .surveys-intro { font-size:14px; color: rgba(173,255,47,0.85); }
    .survey-list{ margin-top:16px; display:grid; grid-template-columns:1fr; gap:12px; }
    .survey { background:rgba(255,255,255,0.02); border:1px solid rgba(173,255,47,0.06); padding:12px; border-radius:10px; }
    .q{ font-weight:700; margin-bottom:8px; color:var(--accent); }
    textarea{ width:100%; min-height:86px; resize:vertical; padding:10px; box-sizing:border-box; background:transparent; color:var(--accent); border:1px dashed rgba(173,255,47,0.08); border-radius:8px; outline:none; font-size:14px; }
    .survey-footer{ display:flex; justify-content:space-between; align-items:center; margin-top:8px; gap:8px; }
    .share-btn{ background:transparent; border:none; color:var(--accent); cursor:pointer; font-size:18px; display:flex; gap:8px; align-items:center;}
    .submit-row{ display:flex; gap:10px; margin-top:18px; align-items:center; }
    .submit-btn{ background:var(--accent); color:#000; padding:12px 16px; border-radius:10px; border:none; font-weight:800; cursor:pointer; flex:1; }
    .reset-btn{ background:transparent; color:var(--accent); border:1px solid rgba(173,255,47,0.08); padding:10px 12px; border-radius:10px; cursor:pointer; }
    .notify{ position:fixed; left:50%; transform:translateX(-50%); bottom:24px; background:rgba(0,0,0,0.8); padding:10px 16px; color:var(--accent); border-radius:10px; border:1px solid rgba(173,255,47,0.06); box-shadow:0 8px 30px rgba(0,0,0,0.6); opacity:0; transition:all .28s; pointer-events:none; z-index:999; }
    .notify.show{ opacity:1; transform:translateX(-50%) translateY(-6px); pointer-events:auto; }
    /* menu modal */
    .menu-modal{ position:fixed; right:16px; top:70px; background:rgba(0,0,0,0.95); border:1px solid rgba(173,255,47,0.06); padding:12px; border-radius:10px; display:none; min-width:180px; z-index:1000; }
    .menu-modal a{ display:block; color:var(--accent); text-decoration:none; padding:8px 6px; border-radius:6px; }
    .menu-modal a:hover{ background:rgba(173,255,47,0.02); }
    .grid-two{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    /* responsive */
    @media (max-width:720px){
      .page{ padding:12px; }
      header{ flex-direction:row; gap:8px; align-items:center; padding:10px; }
      .title{ font-size:16px; }
      .surveys-heading{ font-size:20px; }
      .grid-two{ grid-template-columns:1fr; }
    }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <div class="logo"><a href="#" aria-label="Dollarsurvey logo">DS</a></div>
      <div>
        <div class="title">Welcome to Dollarsurvey</div>
      </div>

      <div class="top-right">
        <div class="user-card" id="userCard" aria-live="polite">
          <div class="uid" id="userId">UID: —</div>
          <div class="balance" id="balance">$0.00</div>
        </div>
        <button class="menu-btn" id="menuBtn" aria-haspopup="true" aria-expanded="false">☰ Menu</button>
      </div>
    </header>

    <div class="menu-modal" id="menuModal" role="dialog" aria-modal="false">
      <a href="#" id="profileLink">Profile</a>
      <a href="#" id="historyLink">My Surveys</a>
      <a href="#" id="helpLink">Help</a>
      <a href="#" id="logoutBtn" style="color:#ff9a9a;">Logout</a>
    </div>

    <main class="hero" id="mainArea">
      <div class="surveys-heading">We have got some surveys for you</div>
      <div class="surveys-intro">Answer a few quick preference questions to earn rewards. Each submission adds <strong>+$0.50</strong> to your balance.</div>

      <form id="surveyForm" class="survey-list" autocomplete="off" novalidate>
        <!-- 10 surveys inserted by JS for clarity -->
      </form>

      <div class="submit-row">
        <button type="button" class="submit-btn" id="submitBtn">Submit all answers</button>
        <button type="button" class="reset-btn" id="resetBtn">Reset</button>
      </div>
    </main>
  </div>

  <div class="notify" id="notify"></div>

  <!-- Firebase SDKs (modular) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-analytics.js";
    import {
      getAuth,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
    import {
      getDatabase,
      ref,
      set,
      push,
      runTransaction,
      get,
      child
    } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js";

    // --- firebase config (from your snippet) ---
    const firebaseConfig = {
      apiKey: "AIzaSyDnq2364tMuRPbrjjHmUfFUTjWZC2BmIS4",
      authDomain: "dollar-survey-60fe7.firebaseapp.com",
      projectId: "dollar-survey-60fe7",
      storageBucket: "dollar-survey-60fe7.firebasestorage.app",
      messagingSenderId: "293471697208",
      appId: "1:293471697208:web:664863f09e830e420c69cd",
      measurementId: "G-RCZ7SQJHPZ"
    };

    const app = initializeApp(firebaseConfig);
    getAnalytics(app);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // UI refs
    const userIdEl = document.getElementById('userId');
    const balanceEl = document.getElementById('balance');
    const notifyEl = document.getElementById('notify');
    const surveyForm = document.getElementById('surveyForm');
    const submitBtn = document.getElementById('submitBtn');
    const resetBtn = document.getElementById('resetBtn');
    const menuBtn = document.getElementById('menuBtn');
    const menuModal = document.getElementById('menuModal');
    const logoutBtn = document.getElementById('logoutBtn');

    // custom notify
    function notify(msg, type = 'info') {
      notifyEl.textContent = msg;
      if(type === 'error') notifyEl.style.borderColor = 'rgba(255,50,50,0.12)';
      else notifyEl.style.borderColor = 'rgba(173,255,47,0.06)';
      notifyEl.classList.add('show');
      clearTimeout(notify._t);
      notify._t = setTimeout(()=> notifyEl.classList.remove('show'), 3500);
    }

    // menu toggle
    menuBtn.addEventListener('click', ()=> {
      const open = menuModal.style.display === 'block';
      menuModal.style.display = open ? 'none' : 'block';
      menuBtn.setAttribute('aria-expanded', String(!open));
    });
    // click outside to close
    window.addEventListener('click', (e)=> {
      if(!menuModal.contains(e.target) && e.target !== menuBtn) menuModal.style.display = 'none';
    });

    // surveys content (10 AdSense-safe product preference survey prompts, each ~50 words)
    const surveyPrompts = [
`A reliable daily-carry backpack: describe which features matter most (pockets, water resistance, laptop pocket, comfort). Which material and color would you prefer for everyday commuting?`,
`Home coffee options: imagine choosing a coffee maker — would you prioritize speed, taste, low upkeep, or price? Describe your ideal machine and why it fits your morning routine.`,
`Smartwatch features: when comparing models, do you value fitness tracking, battery life, style, or app integrations the most? Explain which one you would choose and why.`,
`Kitchen blender choices: for smoothies and sauces do you prefer high-power, compact design, easy-clean parts, or low noise? Explain what matters most in daily use.`,
`Phone case priorities: when buying a phone case, do you prefer slim design, heavy protection, eco-friendly materials, or aesthetics? Describe what you would choose and why.`,
`Streaming headphones: do you choose audio quality, comfort for long sessions, wireless convenience, noise cancellation, or price? Explain how you use them and which feature wins.`,
`Desk lamp for work: would you pick adjustable brightness, color temperature controls, compact size, or eco-friendly LEDs? Describe which lamp features improve your workspace the most.`,
`Sustainable water bottle: when selecting a reusable bottle, do you prioritize insulation, material, capacity, weight, or lid type? Describe the features you’d pay more for.`,
`Home cleaning gadgets: for vacuum or sweepers do you prioritize suction power, battery life, size, smart features, or price? Explain the main reason you’d pick one device.`,
`Outdoor sneakers: are comfort, breathability, waterproofing, sole grip, or style most important when choosing shoes for long walks? Describe which matters most and why.`
    ];

    // populate form with 10 surveys
    function buildSurveys(){
      surveyForm.innerHTML = '';
      surveyPrompts.forEach((q, i) => {
        const idx = i+1;
        const container = document.createElement('div');
        container.className = 'survey';
        container.innerHTML = `
          <div class="q">Q${idx}. ${q}</div>
          <textarea id="ans${idx}" name="ans${idx}" minlength="5" placeholder="Type your answer (min 5 chars)" required></textarea>
          <div class="survey-footer">
            <small>Answer must be at least 5 characters.</small>
            <div>
              <button type="button" class="share-btn" data-idx="${idx}" title="Share this survey">↗ Share</button>
            </div>
          </div>
        `;
        surveyForm.appendChild(container);
      });
    }
    buildSurveys();

    // share handling
    surveyForm.addEventListener('click', async (e)=>{
      const btn = e.target.closest('.share-btn');
      if(!btn) return;
      const url = window.location.origin + window.location.pathname; // homepage link
      try {
        if(navigator.share){
          await navigator.share({ title: 'Dollarsurvey', text: 'Check out this survey site', url });
          notify('Shared via native share.');
        } else {
          await navigator.clipboard.writeText(url);
          notify('Homepage link copied to clipboard.');
        }
      } catch(err){
        await navigator.clipboard.writeText(url);
        notify('Link copied to clipboard.');
      }
    });

    // reset
    resetBtn.addEventListener('click', ()=> {
      if(!confirm('Clear all answers?')) return;
      const areas = surveyForm.querySelectorAll('textarea');
      areas.forEach(t=> t.value = '');
      notify('All answers cleared.');
    });

    // auth & db wiring
    let currentUser = null;

    onAuthStateChanged(auth, async (user) => {
      if(!user){
        // not signed in -> redirect to login
        notify('Not signed in. Redirecting to login...', 'error');
        setTimeout(()=> window.location.href = 'login.html', 900);
        return;
      }
      currentUser = user;
      const email = user.email || '';
      const uidFromEmail = (email.split('@')[0] || '').slice(0,5).toLowerCase() || 'user';
      userIdEl.textContent = 'ID: ' + uidFromEmail;
      // ensure user record exists
      const userRef = ref(db, 'users/' + user.uid);
      // check existing balance
      try{
        const snap = await get(child(ref(db), `users/${user.uid}`));
        if(!snap.exists()){
          await set(userRef, { email: user.email, provider: (user.providerData[0]?.providerId || 'unknown'), balance: 0 });
          balanceEl.textContent = '$0.00';
        } else {
          const data = snap.val();
          const bal = parseFloat(data.balance) || 0;
          balanceEl.textContent = '$' + bal.toFixed(2);
        }
      }catch(err){
        console.error(err);
        notify('Failed to fetch user data', 'error');
      }
    });

    // logout
    logoutBtn.addEventListener('click', async (e)=> {
      try {
        await signOut(auth);
        notify('Signed out. Redirecting to login...');
        setTimeout(()=> window.location.href = 'login.html', 800);
      } catch(err){ notify('Sign out failed', 'error'); }
    });

    // submit handling
    submitBtn.addEventListener('click', async ()=>{
      if(!currentUser) { notify('User not available. Please login again.', 'error'); return; }
      const answers = [];
      let ok = true;
      for(let i=1;i<=10;i++){
        const ta = document.getElementById('ans'+i);
        const v = (ta?.value || '').trim();
        if(!v || v.length < 5){ ok = false; ta?.classList.add('invalid'); }
        answers.push({ q: surveyPrompts[i-1], answer: v });
      }
      if(!ok){ notify('Please answer all surveys (each at least 5 characters).', 'error'); return; }

      // disable UI while submitting
      submitBtn.disabled = true;
      submitBtn.textContent = 'Submitting...';
      try {
        // push response
        const responsesRef = ref(db, 'responses/' + currentUser.uid);
        const newRef = await push(responsesRef, {
          submittedAt: Date.now(),
          answers
        });

        // increment balance by 0.5 with transaction
        const userBalRef = ref(db, 'users/' + currentUser.uid + '/balance');
        await runTransaction(userBalRef, (current) => {
          current = (current === null) ? 0 : Number(current);
          return +(current + 0.5).toFixed(2);
        });

        // read updated balance and show
        const userSnap = await get(ref(db, 'users/' + currentUser.uid));
        const newBal = (userSnap.exists() && parseFloat(userSnap.val().balance)) ? parseFloat(userSnap.val().balance) : 0;
        balanceEl.textContent = '$' + newBal.toFixed(2);

        // clear answers
        surveyForm.querySelectorAll('textarea').forEach(t=> t.value = '');
        notify('Submission successful — +$0.50 added to your balance.');
      } catch(err){
        console.error(err);
        notify('Submission failed. Try again.', 'error');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit all answers';
      }
    });

  </script>
</body>
</html>
