<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Withdraw | Dollar Survey</title>
<style>
  body {
    background: #000;
    color: #39FF14;
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 0;
  }
  header {
    padding: 20px;
    text-align: center;
    background: #111;
    border-bottom: 1px solid #39FF14;
  }
  h1 { font-size: 24px; margin: 0; }
  .container {
    max-width: 500px;
    margin: 30px auto;
    background: rgba(57,255,20,0.05);
    padding: 20px;
    border-radius: 12px;
    border: 1px solid #39FF14;
  }
  .info-box {
    display: flex;
    justify-content: space-between;
    padding: 10px;
    background: #111;
    border-radius: 8px;
    margin-bottom: 20px;
    font-weight: bold;
  }
  select, input, button {
    width: 100%;
    margin-top: 10px;
    padding: 12px;
    border: 1px solid #39FF14;
    background: #000;
    color: #39FF14;
    border-radius: 8px;
    outline: none;
    font-size: 16px;
  }
  button {
    background: #39FF14;
    color: #000;
    font-weight: bold;
    cursor: pointer;
  }
  button:hover {
    background: #00ff66;
  }
  .method-section {
    display: none;
    margin-top: 15px;
  }
  .history {
    margin-top: 30px;
  }
  .history-entry {
    border-top: 1px solid #39FF14;
    padding: 10px 0;
    font-size: 14px;
  }
  #toast {
    position: fixed;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%);
    background: #39FF14;
    color: #000;
    padding: 12px 20px;
    border-radius: 8px;
    display: none;
    font-weight: bold;
    z-index: 999;
  }
</style>
</head>
<body>

<header>
  <h1>Withdraw Funds</h1>
</header>

<div class="container">
  <div class="info-box">
    <div>User ID: <span id="userId">Loading...</span></div>
    <div>Balance: <span id="userBalance">$0.00</span></div>
  </div>

  <select id="method" onchange="switchMethod()">
    <option value="">Select Withdrawal Method</option>
    <option value="bank">Local Bank</option>
    <option value="crypto">Crypto</option>
    <option value="giftcard">Gift Card</option>
  </select>

  <!-- Local Bank -->
  <div id="bankFields" class="method-section">
    <input type="text" id="bankName" placeholder="Bank Name" />
    <input type="text" id="bankCountry" placeholder="Country" />
    <input type="text" id="bankUser" placeholder="Account Holder Name" />
    <input type="number" id="bankAmount" placeholder="Amount" />
  </div>

  <!-- Crypto -->
  <div id="cryptoFields" class="method-section">
    <input type="text" id="cryptoCurrency" placeholder="Currency (e.g. USDT, BTC)" />
    <input type="text" id="cryptoAddress" placeholder="Wallet Address" />
    <input type="number" id="cryptoAmount" placeholder="Amount" />
  </div>

  <!-- Gift Card -->
  <div id="giftcardFields" class="method-section">
    <input type="email" id="giftEmail" placeholder="Your Email" />
    <input type="number" id="giftAmount" placeholder="Amount" />
  </div>

  <button onclick="submitWithdrawal()">Submit Withdrawal</button>

  <div class="history">
    <h3>Withdrawal History</h3>
    <div id="historyList"></div>
  </div>
</div>

<div id="toast"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, doc, getDoc, updateDoc, collection, addDoc, query, orderBy, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDnq2364tMuRPbrjjHmUfFUTjWZC2BmIS4",
  authDomain: "dollar-survey-60fe7.firebaseapp.com",
  projectId: "dollar-survey-60fe7",
  storageBucket: "dollar-survey-60fe7.appspot.com",
  messagingSenderId: "293471697208",
  appId: "1:293471697208:web:664863f09e830e420c69cd"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// UI helpers
let currentUser = null;
const toast = document.getElementById("toast");
function showToast(message, ms=3000) {
  toast.textContent = message;
  toast.style.display = "block";
  setTimeout(()=> toast.style.display = "none", ms);
}
function currency(amount){ return "$" + amount.toFixed(2); }

function switchMethod() {
  document.querySelectorAll('.method-section').forEach(s => s.style.display = 'none');
  const val = document.getElementById('method').value;
  if(val) document.getElementById(val + 'Fields').style.display = 'block';
}

let userBalance = 0;

// Load user info and balance
onAuthStateChanged(auth, async user => {
  if(user){
    currentUser = user;
    const uid = user.uid;
    document.getElementById("userId").textContent = uid.slice(0,6);
    const userRef = doc(db, "users", uid);
    const snap = await getDoc(userRef);
    if(snap.exists()) {
      userBalance = snap.data().balance || 0;
      document.getElementById("userBalance").textContent = currency(userBalance);
    }
    loadHistory(uid);
  } else {
    showToast("Please log in first", 4000);
  }
});

// Submit withdrawal
window.submitWithdrawal = async function() {
  if(!currentUser) return showToast("Not logged in.");

  const method = document.getElementById("method").value;
  if(!method) return showToast("Select a withdrawal method.");

  let amount = 0;
  let details = {};

  if(method === "bank") {
    amount = parseFloat(document.getElementById("bankAmount").value);
    details = {
      bankName: document.getElementById("bankName").value,
      bankCountry: document.getElementById("bankCountry").value,
      accountHolder: document.getElementById("bankUser").value
    };
  }
  if(method === "crypto") {
    amount = parseFloat(document.getElementById("cryptoAmount").value);
    details = {
      currency: document.getElementById("cryptoCurrency").value,
      address: document.getElementById("cryptoAddress").value
    };
  }
  if(method === "giftcard") {
    amount = parseFloat(document.getElementById("giftAmount").value);
    details = {
      email: document.getElementById("giftEmail").value
    };
  }

  if(amount < 100) return showToast("Minimum withdrawal is $100.");
  if(amount > userBalance) return showToast("Insufficient balance.");

  // Deduct and update balance
  const newBalance = userBalance - amount;
  await updateDoc(doc(db, "users", currentUser.uid), { balance: newBalance });
  userBalance = newBalance;
  document.getElementById("userBalance").textContent = currency(newBalance);

  // Record withdrawal
  await addDoc(collection(db, "users", currentUser.uid, "withdrawals"), {
    method,
    amount,
    details,
    status: "pending",
    createdAt: serverTimestamp()
  });

  showToast("Withdrawal submitted successfully!");
  loadHistory(currentUser.uid);
}

// Load withdrawal history
async function loadHistory(uid) {
  const q = query(collection(db, "users", uid, "withdrawals"), orderBy("createdAt", "desc"));
  const snaps = await getDocs(q);
  const container = document.getElementById("historyList");
  container.innerHTML = "";
  snaps.forEach(docSnap => {
    const data = docSnap.data();
    container.innerHTML += `
      <div class="history-entry">
        <strong>${data.method.toUpperCase()}</strong> - ${currency(data.amount)} <br/>
        Status: ${data.status || "pending"}
      </div>
    `;
  });
}
</script>
</body>
</html>
