<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Withdraw Funds</title>
  <style>
    body {
      background-color: #000;
      color: #0f0;
      font-family: 'Poppins', sans-serif;
      padding: 20px;
      text-align: center;
    }

    .withdraw-form, .withdrawal-history {
      background-color: #111;
      border: 1px solid #0f0;
      border-radius: 10px;
      padding: 20px;
      margin: 20px auto;
      max-width: 400px;
      box-shadow: 0 0 15px #0f0;
    }

    input, select, button {
      width: 100%;
      margin: 10px 0;
      padding: 10px;
      background: #000;
      border: 1px solid #0f0;
      color: #0f0;
      border-radius: 5px;
    }

    button {
      background: #0f0;
      color: #000;
      font-weight: bold;
      cursor: pointer;
      transition: 0.3s;
    }

    button:hover {
      background: #1aff1a;
    }

    h3, h2, h4 {
      color: #0f0;
    }

    #withdraw-msg {
      margin-top: 10px;
    }

    .withdraw-item {
      border-bottom: 1px solid #0f0;
      padding: 5px 0;
      font-size: 14px;
    }
  </style>
</head>
<body>

  <h1>Withdrawal Page</h1>
  <h3>User ID: <span id="userId"></span></h3>
  <h3>Balance: <span id="balance"></span></h3>

  <div class="withdraw-form">
    <h3>Submit Withdrawal</h3>

    <input type="number" id="withdrawAmount" placeholder="Enter amount ($)" />
    <select id="withdrawMethod" onchange="showMethodFields()">
      <option value="">Select Method</option>
      <option value="bank">Bank</option>
      <option value="crypto">Crypto Wallet</option>
      <option value="giftcard">Gift Card</option>
    </select>

    <!-- Bank Fields -->
    <div id="bankFields" class="method-fields" style="display: none;">
      <input type="text" placeholder="Account Holder Name" id="bankHolder"/>
      <input type="text" placeholder="Bank Name" id="bankName"/>
      <input type="text" placeholder="Account Number" id="bankAccount"/>
      <input type="text" placeholder="Country" id="bankCountry"/>
    </div>

    <!-- Crypto Fields -->
    <div id="cryptoFields" class="method-fields" style="display: none;">
      <input type="text" placeholder="Wallet Address" id="cryptoAddress"/>
      <input type="text" placeholder="Coin Type (e.g., USDT, BTC)" id="cryptoCoin"/>
    </div>

    <!-- Gift Card Fields -->
    <div id="giftcardFields" class="method-fields" style="display: none;">
      <input type="email" placeholder="Your Email Address" id="giftEmail"/>
      <input type="text" placeholder="Type of Gift Card (e.g., Amazon, iTunes)" id="giftType"/>
    </div>

    <button id="withdrawBtn" onclick="submitWithdraw()">Withdraw</button>
    <p id="withdraw-msg"></p>
  </div>

  <!-- Withdrawal History -->
  <div class="withdrawal-history">
    <h3>Recent Withdrawals</h3>
    <div id="recent-withdrawals"></div>
    <button onclick="toggleAllWithdrawals()" id="view-all-btn">View All</button>
  </div>

  <h2>Note: Withdrawal updates are sent to your email.</h2>
  <h4>Need help? Contact us at: <br><a href="mailto:dollarsurveyus@gmail.com" style="color:#0f0;">dollarsurveyus@gmail.com</a></h4>

  <!-- JS LOGIC -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
    import { getDatabase, ref, get, update, push, child, set } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDnq2364tMuRPbrjjHmUfFUTjWZC2BmIS4",
      authDomain: "dollar-survey-60fe7.firebaseapp.com",
      projectId: "dollar-survey-60fe7",
      storageBucket: "dollar-survey-60fe7.firebasestorage.app",
      messagingSenderId: "293471697208",
      appId: "1:293471697208:web:664863f09e830e420c69cd",
      measurementId: "G-RCZ7SQJHPZ"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const userIdEl = document.getElementById('userId');
    const balanceEl = document.getElementById('balance');
    const msg = document.getElementById('withdraw-msg');
    const recentDiv = document.getElementById('recent-withdrawals');

    let userId = null;
    let currentBalance = 0;
    let showAll = false;

    // Guest ID support (same as homepage)
    const guestIdKey = 'ds_guest_id_v1';
    function ensureGuestId(){
      let g = localStorage.getItem(guestIdKey);
      if(!g){
        g = 'g-' + Math.random().toString(36).slice(2,9);
        localStorage.setItem(guestIdKey, g);
      }
      return g;
    }
    const guestId = ensureGuestId();

    // Load user data
    onAuthStateChanged(auth, async (user) => {
      userId = user ? user.uid : guestId;
      userIdEl.textContent = userId;

      const balRef = ref(db, `users/${userId}/balance`);
      const balSnap = await get(balRef);
      currentBalance = balSnap.exists() ? balSnap.val() : 0;
      updateBalanceUI();
      loadWithdrawals();
    });

    function currency(amount){
      return '$' + amount.toFixed(2);
    }

    function updateBalanceUI(){
      balanceEl.textContent = currency(currentBalance);
    }

    // Show method fields
    window.showMethodFields = function() {
      document.querySelectorAll('.method-fields').forEach(div => div.style.display = 'none');
      const method = document.getElementById('withdrawMethod').value;
      if(method) document.getElementById(method + 'Fields').style.display = 'block';
    }

    // Submit withdraw
    window.submitWithdraw = async function(){
      const amount = parseFloat(document.getElementById('withdrawAmount').value);
      const method = document.getElementById('withdrawMethod').value;
      if(!amount || amount <= 0 || !method){
        msg.textContent = "Please enter valid amount and method.";
        msg.style.color = "red";
        return;
      }

      if(amount < 100){
        msg.textContent = "Minimum withdrawal is $100.";
        msg.style.color = "red";
        await logWithdrawal(amount, method, "Failed (Below Minimum)");
        return;
      }

      if(amount > currentBalance){
        msg.textContent = "Insufficient balance!";
        msg.style.color = "red";
        await logWithdrawal(amount, method, "Failed (Insufficient Funds)");
        return;
      }

      // Success — deduct
      currentBalance -= amount;
      await update(ref(db, `users/${userId}`), { balance: currentBalance });
      await logWithdrawal(amount, method, "Successful");
      updateBalanceUI();
      msg.textContent = "Withdrawal submitted successfully!";
      msg.style.color = "#0f0";
      loadWithdrawals();
    }

    // Log withdrawal
    async function logWithdrawal(amount, method, status){
      const logRef = push(ref(db, `users/${userId}/withdrawals`));
      await set(logRef, {
        amount,
        method,
        status,
        date: new Date().toLocaleString()
      });
    }

    // Load withdrawals
    async function loadWithdrawals(){
      const snap = await get(ref(db, `users/${userId}/withdrawals`));
      if(!snap.exists()){
        recentDiv.innerHTML = "<p>No withdrawals yet.</p>";
        return;
      }

      const data = Object.values(snap.val());
      const displayData = showAll ? data : data.slice(-5);
      recentDiv.innerHTML = displayData.reverse().map(w => `
        <div class="withdraw-item">
          <strong>${currency(w.amount)}</strong> via ${w.method}<br>
          <em>${w.status}</em> — ${w.date}
        </div>
      `).join('');
    }

    // Toggle all
    window.toggleAllWithdrawals = function(){
      showAll = !showAll;
      document.getElementById('view-all-btn').textContent = showAll ? "View Less" : "View All";
      loadWithdrawals();
    }
  </script>

</body>
</html>
