<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dollarsurvey | Withdraw</title>
  <style>
    :root{
      --bg:#000;
      --accent:#adff2f;
      --accent-darker:#8fd120;
      --muted:rgba(173,255,47,0.04);
      --card-shadow: 0 8px 36px rgba(173,255,47,0.05);
      --glass: rgba(0,255,0,0.03);
      --toast-bg: rgba(10,10,10,0.95);
      --max-width:920px;
      --radius:12px;
      --gap:14px;
    }
    html,body{height:100%;}
    body{
      margin:0;
      font-family: "Segoe UI", system-ui, -apple-system, "Helvetica Neue", Arial;
      background:var(--bg);
      color:var(--accent);
      display:flex;
      justify-content:center;
      padding:28px 12px;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    .wrap{
      width:100%;
      max-width:var(--max-width);
      display:flex;
      flex-direction:column;
      gap:var(--gap);
    }

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:8px 4px;
    }

    .left{
      display:flex;
      align-items:center;
      gap:12px;
    }

    .logo {
      width:56px;
      height:56px;
      border-radius:8px;
      background:linear-gradient(180deg,#0b0b0b 0%, rgba(173,255,47,0.06) 100%);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-weight:bold;
      text-decoration:none;
      color:var(--accent);
      border:1px solid rgba(173,255,47,0.12);
    }

    .info-boxes{
      display:flex;
      gap:8px;
      align-items:center;
    }
    .info{
      display:flex;
      align-items:center;
      gap:8px;
      background:var(--glass);
      padding:6px 10px;
      border-radius:8px;
      border:1px solid rgba(173,255,47,0.08);
      font-size:13px;
      min-width:110px;
      justify-content:center;
      box-shadow:var(--card-shadow);
    }
    .info b{color:var(--accent); font-weight:700;}

    main{
      background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.06));
      border-radius:var(--radius);
      padding:20px;
      border:1px solid rgba(173,255,47,0.06);
      box-shadow:var(--card-shadow);
    }

    main h1{
      margin:0 0 8px 0;
      font-size:20px;
      color:var(--accent);
      font-weight:900;
    }
    .subtitle{margin:0 0 18px 0; color:rgba(173,255,47,0.9); font-size:13px;}

    .balance-card{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      padding:12px;
      border-radius:10px;
      border:1px solid rgba(173,255,47,0.06);
      background:rgba(173,255,47,0.02);
    }
    .balance-card .left-text{display:flex; flex-direction:column; gap:6px;}
    .bal-label{font-size:12px; color:rgba(173,255,47,0.8);}
    .bal-amount{font-size:20px; font-weight:900; color:var(--accent);}

    .tabs{
      display:flex;
      gap:8px;
      margin-top:18px;
      margin-bottom:10px;
    }
    .tab-btn{
      background:transparent;
      border:1px solid rgba(173,255,47,0.06);
      padding:8px 12px;
      border-radius:10px;
      cursor:pointer;
      color:var(--accent);
      font-weight:700;
    }
    .tab-btn.active{
      background:var(--accent);
      color:#000;
      border-color:var(--accent-darker);
    }

    .form-wrap{
      margin-top:8px;
      display:block;
    }
    form{
      display:grid;
      gap:10px;
      margin-top:6px;
    }
    label{font-size:13px; color:rgba(173,255,47,0.9);}
    input[type="text"], input[type="number"], input[type="email"], select, textarea{
      background:transparent;
      border:1px solid rgba(173,255,47,0.06);
      padding:10px 12px;
      border-radius:10px;
      color:var(--accent);
      outline:none;
      font-size:14px;
    }
    textarea{min-height:80px; resize:vertical;}

    .row{display:flex; gap:10px;}
    .row .col{flex:1;}

    .submit-btn{
      background:var(--accent);
      color:black;
      border:none;
      padding:12px 16px;
      border-radius:10px;
      font-weight:800;
      cursor:pointer;
      min-width:160px;
      box-shadow:0 8px 30px rgba(173,255,47,0.06);
      margin-top:6px;
    }
    .submit-btn[disabled]{opacity:0.5; cursor:not-allowed;}

    .note{font-size:13px; color:rgba(173,255,47,0.8); margin-top:6px;}

    .toast{
      position:fixed;
      bottom:18px;
      left:50%;
      transform:translateX(-50%);
      background:var(--toast-bg);
      color:var(--accent);
      padding:12px 16px;
      border-radius:10px;
      border:1px solid rgba(173,255,47,0.08);
      box-shadow:0 8px 30px rgba(0,0,0,0.6);
      display:none;
      z-index:80;
      font-weight:700;
    }

    /* responsive */
    @media (max-width:880px){
      .row{flex-direction:column;}
      .logo{width:48px;height:48px;}
    }
  </style>
</head>
<body>
 

    <main>
      <h1>Withdraw funds</h1>
      <p class="subtitle">Choose how you'd like to withdraw. Minimum withdrawal: <strong>$100</strong>. Withdrawn amount will be subtracted immediately.</p>

      <div class="balance-card" aria-live="polite">
        <div class="left-text">
          <div class="bal-label">Current Account</div>
          <div class="bal-amount" id="balanceDisplay">$0.00</div>
        </div>
        <div style="text-align:right;">
          <div class="bal-label">User</div>
          <div style="font-weight:800; color:var(--accent)" id="userDisplay">guest</div>
        </div>
      </div>

      <div class="tabs" role="tablist" aria-label="Withdrawal method">
        <button class="tab-btn active" data-tab="bank">Local Bank</button>
        <button class="tab-btn" data-tab="crypto">Crypto</button>
        <button class="tab-btn" data-tab="gift">Giftcard</button>
      </div>

      <div class="form-wrap">
        <!-- Bank Form -->
        <form id="bankForm" data-type="bank">
          <label>Bank Name</label>
          <input type="text" id="bank_name" placeholder="e.g., First Bank" required>

          <div class="row">
            <div class="col">
              <label>Country</label>
              <input type="text" id="bank_country" placeholder="Country" required>
            </div>
            <div class="col">
              <label>Account Name</label>
              <input type="text" id="bank_account_name" placeholder="Name on account" required>
            </div>
          </div>

          <label>Account Number</label>
          <input type="text" id="bank_account_number" placeholder="Account number" required>

          <label>Amount (USD)</label>
          <input type="number" id="bank_amount" placeholder="100.00" min="100" step="0.01" required>

          <button type="button" id="bankSubmit" class="submit-btn">Withdraw to Bank</button>
          <div class="note">Note: Minimum withdrawal is $100. Balance must cover withdrawal.</div>
        </form>

        <!-- Crypto Form -->
        <form id="cryptoForm" style="display:none" data-type="crypto">
          <label>Currency</label>
          <select id="crypto_currency" required>
            <option value="BTC">BTC</option>
            <option value="ETH">ETH</option>
            <option value="USDT">USDT</option>
            <option value="BNB">BNB</option>
          </select>

          <label>Amount (USD equivalent)</label>
          <input type="number" id="crypto_amount" placeholder="100.00" min="100" step="0.01" required>

          <label>Wallet Address</label>
          <input type="text" id="crypto_address" placeholder="Crypto address" required>

          <button type="button" id="cryptoSubmit" class="submit-btn">Withdraw to Crypto</button>
        </form>

        <!-- Giftcard Form -->
        <form id="giftForm" style="display:none" data-type="gift">
          <label>Giftcard Email</label>
          <input type="email" id="gift_email" placeholder="email@example.com" required>

          <label>Amount (USD)</label>
          <input type="number" id="gift_amount" placeholder="100.00" min="100" step="0.01" required>

          <button type="button" id="giftSubmit" class="submit-btn">Send Giftcard</button>
        </form>
      </div>
    </main>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <!-- Firebase + logic -->
  <script type="module">
    // Firebase imports (same version as homepage)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-analytics.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
    import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js";

    // same firebaseConfig as the homepage you provided
    const firebaseConfig = {
      apiKey: "AIzaSyDnq2364tMuRPbrjjHmUfFUTjWZC2BmIS4",
      authDomain: "dollar-survey-60fe7.firebaseapp.com",
      projectId: "dollar-survey-60fe7",
      storageBucket: "dollar-survey-60fe7.firebasestorage.app",
      messagingSenderId: "293471697208",
      appId: "1:293471697208:web:664863f09e830e420c69cd",
      measurementId: "G-RCZ7SQJHPZ"
    };

    const app = initializeApp(firebaseConfig);
    try { getAnalytics(app); } catch(e) { /* ignore in some envs */ }

    const auth = getAuth(app);
    const db = getDatabase(app);

    // UI refs
    const userDisplay = document.getElementById('userDisplay');
    const balanceDisplay = document.getElementById('balanceDisplay');
    const userIdEl = document.getElementById('userId');
    const toast = document.getElementById('toast');

    const guestIdKey = 'ds_guest_id_v1';
    function ensureGuestId(){
      let g = localStorage.getItem(guestIdKey);
      if(!g){
        g = 'g-' + Math.random().toString(36).slice(2,9);
        localStorage.setItem(guestIdKey, g);
      }
      return g;
    }
    const guestId = ensureGuestId();

    // local balance mirror
    let localBalance = 0.00;
    let currentUser = null;

    function currency(amount){
      return '$' + Number(amount).toFixed(2);
    }

    function showToast(message, ms=3000){
      toast.textContent = message;
      toast.style.display = 'block';
      setTimeout(()=> { toast.style.display = 'none'; }, ms);
    }

    async function fetchBalanceForUid(uid){
      try {
        const snap = await get(ref(db, 'users/' + uid + '/balance'));
        if(snap && snap.exists && typeof snap.val === 'function'){
          const val = Number(snap.val()) || 0;
          localBalance = +val;
          updateBalanceUI();
        }
      } catch(e){
        console.warn('Could not fetch user balance', e);
      }
    }

    async function fetchBalanceForGuest(gid){
      try {
        const snap = await get(ref(db, 'guests/' + gid + '/balance'));
        if(snap && snap.exists && typeof snap.val === 'function'){
          const val = Number(snap.val()) || 0;
          localBalance = +val;
          updateBalanceUI();
        }
      } catch(e){
        console.warn('Could not fetch guest balance', e);
      }
    }

    function updateBalanceUI(){
      balanceDisplay.textContent = currency(localBalance);
      // update header userId as well for visual parity with homepage
      const id = currentUser && currentUser.email ? currentUser.email.slice(0,5).toLowerCase() : guestId.slice(0,5);
      userDisplay.textContent = id;
      userIdEl && (userIdEl.textContent = id);
      // persist local mirror
      localStorage.setItem('ds_local_balance_v1', String(localBalance));
    }

    // write new balance to firebase (same paths as homepage)
    async function writeBalanceToFirebase(newBalance){
      try {
        if(currentUser && currentUser.uid){
          await set(ref(db, 'users/' + currentUser.uid + '/balance'), +newBalance);
        } else {
          await set(ref(db, 'guests/' + guestId + '/balance'), +newBalance);
        }
      } catch(e){
        console.warn('Failed to write balance to firebase', e);
      }
    }

    // tab switching
    document.querySelectorAll('.tab-btn').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        const tab = btn.dataset.tab;
        document.getElementById('bankForm').style.display = tab === 'bank' ? 'block' : 'none';
        document.getElementById('cryptoForm').style.display = tab === 'crypto' ? 'block' : 'none';
        document.getElementById('giftForm').style.display = tab === 'gift' ? 'block' : 'none';
      });
    });

    // validators
    function validateAmountField(val){
      const n = Number(val);
      if(!isFinite(n) || n <= 0) return {ok:false, msg:'Invalid amount'};
      if(n < 100) return {ok:false, msg:'Minimum withdrawal is $100'};
      if(n > localBalance) return {ok:false, msg:'Insufficient balance'};
      return {ok:true, value: +n};
    }

    // core withdraw handler (shared for types)
    async function handleWithdraw({amount, metadata}){
      // subtract immediately
      const amt = Number(amount);
      localBalance = +(localBalance - amt).toFixed(2);
      updateBalanceUI();

      // attempt firebase update (best-effort)
      await writeBalanceToFirebase(localBalance);

      // show success toast exactly as requested
      showToast('Successful withdrawal', 3000);

      // You chose option A: no withdrawal record will be stored (just subtraction + toast).
      // If you later want to store the withdrawal history, we can add that path.
    }

    // attach form submissions
    document.getElementById('bankSubmit').addEventListener('click', async ()=>{
      const bankName = document.getElementById('bank_name').value.trim();
      const country = document.getElementById('bank_country').value.trim();
      const accName = document.getElementById('bank_account_name').value.trim();
      const accNumber = document.getElementById('bank_account_number').value.trim();
      const amount = document.getElementById('bank_amount').value;

      if(!bankName || !country || !accName || !accNumber){
        showToast('Please complete all bank details', 2800);
        return;
      }
      const validated = validateAmountField(amount);
      if(!validated.ok){ showToast(validated.msg, 2800); return; }

      // disable button while processing
      const btn = document.getElementById('bankSubmit');
      btn.disabled = true;
      btn.textContent = 'Processing...';

      await handleWithdraw({ amount: validated.value, metadata: { type:'bank', bankName, country, accName, accNumber } });

      // reset UI
      btn.disabled = false;
      btn.textContent = 'Withdraw to Bank';
      // clear amount field only
      document.getElementById('bank_amount').value = '';
    });

    document.getElementById('cryptoSubmit').addEventListener('click', async ()=>{
      const currencySel = document.getElementById('crypto_currency').value;
      const address = document.getElementById('crypto_address').value.trim();
      const amount = document.getElementById('crypto_amount').value;

      if(!address){
        showToast('Please provide a wallet address', 2800);
        return;
      }
      const validated = validateAmountField(amount);
      if(!validated.ok){ showToast(validated.msg, 2800); return; }

      const btn = document.getElementById('cryptoSubmit');
      btn.disabled = true;
      btn.textContent = 'Processing...';

      await handleWithdraw({ amount: validated.value, metadata: { type:'crypto', currency:currencySel, address } });

      btn.disabled = false;
      btn.textContent = 'Withdraw to Crypto';
      document.getElementById('crypto_amount').value = '';
    });

    document.getElementById('giftSubmit').addEventListener('click', async ()=>{
      const email = document.getElementById('gift_email').value.trim();
      const amount = document.getElementById('gift_amount').value;

      if(!email){
        showToast('Please provide an email for giftcard delivery', 2800);
        return;
      }
      const validated = validateAmountField(amount);
      if(!validated.ok){ showToast(validated.msg, 2800); return; }

      const btn = document.getElementById('giftSubmit');
      btn.disabled = true;
      btn.textContent = 'Processing...';

      await handleWithdraw({ amount: validated.value, metadata: { type:'giftcard', email } });

      btn.disabled = false;
      btn.textContent = 'Send Giftcard';
      document.getElementById('gift_amount').value = '';
    });

    // auth tracking to determine path (keeps parity with homepage)
    onAuthStateChanged(auth, (user) => {
      currentUser = user;
      if(user && user.email){
        const id = user.email.slice(0,5).toLowerCase();
        userDisplay.textContent = id;
        userIdEl && (userIdEl.textContent = id);
        // fetch balance for this uid
        fetchBalanceForUid(user.uid).then(()=>{
          updateBalanceUI();
        });
      } else {
        // guest
        userDisplay.textContent = guestId.slice(0,5);
        userIdEl && (userIdEl.textContent = guestId.slice(0,5));
        // fetch guest balance
        fetchBalanceForGuest(guestId);
        // also load local mirror if available
        const saved = localStorage.getItem('ds_local_balance_v1');
        if(saved && !isNaN(Number(saved))){
          localBalance = Number(saved);
          updateBalanceUI();
        }
      }
    });

    // also attempt to initialize mirror from localStorage on load
    (function initLocalMirror(){
      const saved = localStorage.getItem('ds_local_balance_v1');
      if(saved && !isNaN(Number(saved))){
        localBalance = Number(saved);
        updateBalanceUI();
      }
    })();

    // persist balance on unload (same behaviour as homepage)
    window.addEventListener('beforeunload', ()=> {
      localStorage.setItem('ds_local_balance_v1', String(localBalance));
    });
  </script>
</body>
</html>

