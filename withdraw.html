<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dollarsurvey | Withdraw</title>
  <style>
    :root{
      --bg:#000;
      --accent:#adff2f;
      --accent-dark:#8fd120;
      --muted:rgba(175,255,90,0.06);
      --glass: rgba(0,255,0,0.03);
      --toast-bg: rgba(10,10,10,0.95);
    }
    body{
      margin:0;
      background:var(--bg);
      color:var(--accent);
      font-family: "Segoe UI", system-ui, sans-serif;
      display:flex;
      justify-content:center;
      padding:30px 14px;
      -webkit-font-smoothing:antialiased;
    }
    .wrap{
      width:100%;
      max-width:480px;
      display:flex;
      flex-direction:column;
      gap:24px;
    }
    header{
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .logo{
      font-weight:900;
      font-size:20px;
      text-decoration:none;
      color:var(--accent);
    }
    .info-box{
      background:var(--glass);
      padding:10px 14px;
      border-radius:10px;
      border:1px solid rgba(173,255,47,0.08);
      text-align:right;
      font-size:14px;
    }
    main h1{
      font-size:24px;
      font-weight:900;
      margin:0;
    }
    .method-select{
      display:flex;
      gap:10px;
      margin-top:12px;
    }
    .method-select button{
      flex:1;
      background:transparent;
      border:2px solid var(--accent);
      color:var(--accent);
      font-weight:700;
      padding:10px;
      border-radius:8px;
      cursor:pointer;
      transition:0.2s;
    }
    .method-select button.active{
      background:var(--accent);
      color:#000;
    }
    form{
      display:flex;
      flex-direction:column;
      gap:12px;
      margin-top:16px;
    }
    input,select{
      padding:12px;
      border-radius:8px;
      border:1px solid rgba(173,255,47,0.08);
      background:transparent;
      color:var(--accent);
      font-size:14px;
      outline:none;
    }
    input::placeholder{color:rgba(173,255,47,0.5);}
    .submit-btn{
      background:var(--accent);
      color:#000;
      font-weight:800;
      border:none;
      padding:14px;
      border-radius:10px;
      cursor:pointer;
      font-size:16px;
      margin-top:8px;
    }
    .submit-btn[disabled]{
      opacity:0.5;
      cursor:not-allowed;
    }
    .toast{
      position:fixed;
      bottom:20px;
      left:50%;
      transform:translateX(-50%);
      background:var(--toast-bg);
      padding:14px 20px;
      border-radius:10px;
      font-weight:700;
      border:1px solid rgba(173,255,47,0.08);
      display:none;
      z-index:100;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <a href="index.html" class="logo">← Back</a>
      <div class="info-box">
        <div>ID: <b id="userId">guest</b></div>
        <div>Balance: <b id="balance">$0.00</b></div>
      </div>
    </header>

    <main>
      <h1>Withdraw Funds</h1>
      <p>Minimum withdrawal: <b>$100.00</b></p>

      <div class="method-select">
        <button type="button" class="active" data-method="bank">Local Bank</button>
        <button type="button" data-method="crypto">Crypto</button>
        <button type="button" data-method="giftcard">Gift Card</button>
      </div>

      <form id="withdrawForm">
        <!-- Dynamic fields here -->
      </form>

      <button id="submitBtn" class="submit-btn">Withdraw</button>
    </main>
  </div>

  <div id="toast" class="toast"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
    import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDnq2364tMuRPbrjjHmUfFUTjWZC2BmIS4",
      authDomain: "dollar-survey-60fe7.firebaseapp.com",
      projectId: "dollar-survey-60fe7",
      storageBucket: "dollar-survey-60fe7.firebasestorage.app",
      messagingSenderId: "293471697208",
      appId: "1:293471697208:web:664863f09e830e420c69cd",
      measurementId: "G-RCZ7SQJHPZ"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const userIdEl = document.getElementById('userId');
    const balanceEl = document.getElementById('balance');
    const form = document.getElementById('withdrawForm');
    const submitBtn = document.getElementById('submitBtn');
    const toast = document.getElementById('toast');

    let currentUser = null;
    let guestId = localStorage.getItem('ds_guest_id_v1');
    if(!guestId){
      guestId = 'g-' + Math.random().toString(36).slice(2,9);
      localStorage.setItem('ds_guest_id_v1', guestId);
    }
    let localBalance = 0;

    const methods = document.querySelectorAll('.method-select button');
    methods.forEach(btn => {
      btn.addEventListener('click', ()=>{
        methods.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        renderForm(btn.dataset.method);
      });
    });

    function renderForm(method='bank'){
      if(method === 'bank'){
        form.innerHTML = `
          <input type="text" id="bankName" placeholder="Bank Name" required />
          <input type="text" id="country" placeholder="Country" required />
          <input type="text" id="accName" placeholder="Account Name" required />
          <input type="number" id="amount" placeholder="Amount (USD)" required min="100" />
        `;
      } else if(method === 'crypto'){
        form.innerHTML = `
          <input type="text" id="currency" placeholder="Currency (e.g. BTC, ETH)" required />
          <input type="text" id="address" placeholder="Wallet Address" required />
          <input type="number" id="amount" placeholder="Amount (USD)" required min="100" />
        `;
      } else {
        form.innerHTML = `
          <input type="email" id="email" placeholder="Email" required />
          <input type="number" id="amount" placeholder="Amount (USD)" required min="100" />
        `;
      }
    }
    renderForm();

    function showToast(msg, ms=3000){
      toast.textContent = msg;
      toast.style.display = 'block';
      setTimeout(()=>toast.style.display='none', ms);
    }

    function updateBalanceUI(){ balanceEl.textContent = '$' + localBalance.toFixed(2); }

    async function loadBalance(uid){
      try {
        const path = uid ? `users/${uid}/balance` : `guests/${guestId}/balance`;
        const snap = await get(ref(db, path));
        if(snap.exists()) localBalance = Number(snap.val()) || 0;
      } catch(e){}
      updateBalanceUI();
    }

    onAuthStateChanged(auth, async (user)=>{
      currentUser = user;
      userIdEl.textContent = user && user.email ? user.email.slice(0,5).toLowerCase() : guestId.slice(0,5);
      await loadBalance(user?.uid);
    });

    submitBtn.addEventListener('click', async ()=>{
      const method = document.querySelector('.method-select button.active').dataset.method;
      const amount = Number(document.getElementById('amount').value);
      if(isNaN(amount) || amount < 100){
        showToast('Minimum withdrawal is $100');
        return;
      }
      if(amount > localBalance){
        showToast('Insufficient balance');
        return;
      }

      // subtract balance immediately
      localBalance = +(localBalance - amount).toFixed(2);
      updateBalanceUI();

      const uid = currentUser?.uid || null;
      const balancePath = uid ? `users/${uid}/balance` : `guests/${guestId}/balance`;
      const withdrawalPath = uid ? `withdrawals/users/${uid}/${Date.now()}` : `withdrawals/guests/${guestId}/${Date.now()}`;

      const payload = {
        method,
        amount,
        timestamp: Date.now(),
        form: Object.fromEntries(new FormData(form).entries())
      };

      await set(ref(db, balancePath), localBalance);
      await set(ref(db, withdrawalPath), payload);

      showToast('✅ Successful withdrawal!');
      form.reset();
    });
  </script>
</body>
</html>
